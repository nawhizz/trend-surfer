# TrendSurfer Backend

TrendSurferì˜ ë°±ì—”ë“œ ì‹œìŠ¤í…œì…ë‹ˆë‹¤. í•œêµ­ ì£¼ì‹ ì‹œì¥(KOSPI, KOSDAQ)ì˜ ë°ì´í„°ë¥¼ ìˆ˜ì§‘í•˜ê³ , ì •ëŸ‰ì  ì „ëµ(Quantitative Strategy)ì„ ì‹¤í–‰ ë° ê²€ì¦í•©ë‹ˆë‹¤.

## ğŸ›  ê¸°ìˆ  ìŠ¤íƒ

- **Framework**: FastAPI
- **Language**: Python 3.12+
- **Manager**: [uv](https://github.com/astral-sh/uv)
- **Database**: Supabase (PostgreSQL)
- **Data**: FinanceDataReader, KRX Open API

---

## ğŸš€ ì‹œì‘í•˜ê¸° (Getting Started)

### 1. í™˜ê²½ ì„¤ì •

`uv` íŒ¨í‚¤ì§€ ë§¤ë‹ˆì €ê°€ ì„¤ì¹˜ë˜ì–´ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.

```bash
# í”„ë¡œì íŠ¸ ì˜ì¡´ì„± ì„¤ì¹˜
uv sync
```

### 2. í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
`backend/.env` íŒŒì¼ì„ ìƒì„±í•˜ê³  ì•„ë˜ ë‚´ìš©ì„ ì„¤ì •í•˜ì„¸ìš”.

```ini
SUPABASE_URL="YOUR_SUPABASE_URL"
SUPABASE_KEY="YOUR_SUPABASE_KEY"
KRX_API_KEY="YOUR_KRX_API_KEY"

# í‚¤ì›€ì¦ê¶Œ REST API (ê²½ê³ ì¢…ëª© ì¡°íšŒìš©)
KIWOOM_APP_KEY="YOUR_KIWOOM_APP_KEY"
KIWOOM_APP_SECRET="YOUR_KIWOOM_APP_SECRET"
KIWOOM_IS_PAPER_TRADING=True
```

### 3. ì„œë²„ ì‹¤í–‰ (API)
ë°ì´í„° ìˆ˜ì§‘ ë° ë°±í…ŒìŠ¤íŠ¸ëŠ” ìŠ¤í¬ë¦½íŠ¸ë¡œ ì‹¤í–‰í•˜ë¯€ë¡œ, API ì„œë²„ ì‹¤í–‰ì€ í•„ìˆ˜ì ì¸ ê²ƒì€ ì•„ë‹™ë‹ˆë‹¤.

```bash
uv run uvicorn app.main:app --reload
```

---

## ğŸ“… Daily Operation (ë§¤ì¼ ì‘ì—…)

ë§¤ì¼ ì¥ ë§ˆê° í›„ ì‹¤í–‰í•˜ëŠ” ìë™í™” ë£¨í‹´ì…ë‹ˆë‹¤. ë°ì´í„° ìˆ˜ì§‘, ë³´ì •, ì§€í‘œ ê³„ì‚°, ì‹œê·¸ë„ ìƒì„±ì„ ì¼ê´„ ì²˜ë¦¬í•©ë‹ˆë‹¤.

### 1. ìë™ ì‹¤í–‰ (One-Step)
ê°€ì¥ ê¶Œì¥ë˜ëŠ” ë°©ë²•ì…ë‹ˆë‹¤. `daily_routine.py`ê°€ ì•„ë˜ ëª¨ë“  ë‹¨ê³„ë¥¼ ìˆœì°¨ì ìœ¼ë¡œ ì‹¤í–‰í•©ë‹ˆë‹¤.

```bash
# ì‹¤í–‰ (backend ë””ë ‰í† ë¦¬ì—ì„œ)
uv run ../scripts/daily_routine.py
```

**ìœˆë„ìš° ì‘ì—… ìŠ¤ì¼€ì¤„ëŸ¬ ë“±ë¡**:
`scripts/run_daily_routine.bat` íŒŒì¼ì„ ë“±ë¡í•˜ì—¬ ë§¤ì¼ 16:30ì— ì‹¤í–‰ë˜ë„ë¡ ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### 2. ìƒì„¸ í”„ë¡œì„¸ìŠ¤ (Internal Steps)
`daily_routine.py`ëŠ” ë‚´ë¶€ì ìœ¼ë¡œ ë‹¤ìŒ ìŠ¤í…ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤. í•„ìš” ì‹œ ê°œë³„ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ìˆ˜ë™ìœ¼ë¡œ ì‹¤í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

| ë‹¨ê³„ | ìŠ¤í¬ë¦½íŠ¸ | ì„¤ëª… |
|------|----------|------|
| **1. ì¢…ëª© ê°±ì‹ ** | `run_collector.py --mode tickers` | ì‹ ê·œ ìƒì¥/ìƒì¥ íì§€ ì¢…ëª© ë§ˆìŠ¤í„° ì—…ë°ì´íŠ¸ |
| **2. ìˆ˜ì •ì£¼ê°€** | `update_adjusted_prices.py` | ì•¡ë©´ë¶„í•  ë“± ì´ë²¤íŠ¸ ê°ì§€ ë° ê³¼ê±° ë°ì´í„° ìë™ ë°±í•„ |
| **3. ì‹œì„¸ ìˆ˜ì§‘** | `run_collector.py --mode daily` | ë‹¹ì¼ OHLCV ë° ê±°ë˜ëŒ€ê¸ˆ(KRX) ìˆ˜ì§‘ |
| **4. ì§€í‘œ ê³„ì‚°** | `run_daily_indicators.py` | ë‹¹ì¼ ìº”ë“¤ ê¸°ì¤€ ê¸°ìˆ ì  ì§€í‘œ(MA, EMA_STAGE, ATR ë“±) ê³„ì‚° |
| **5. ê²½ê³ ì¢…ëª©** | `update_warning_stocks.py` | ê´€ë¦¬ì¢…ëª©, íˆ¬ìê²½ê³ , ê±°ë˜ì •ì§€ ë“± ê²½ê³  ìƒíƒœ ì—…ë°ì´íŠ¸ (í‚¤ì›€ API) |
| **6. ì „ëµ ì‹¤í–‰** | `run_strategy.py` | í¬ì°©ëœ ì¢…ëª©(ì‹œê·¸ë„) ìŠ¤ìº” ë° ë¦¬ìŠ¤íŠ¸ ì¶œë ¥ |

---

## ğŸ§ª Backtest & Strategy (ë°±í…ŒìŠ¤íŠ¸ ë° ë¶„ì„)

ê³¼ê±° ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì „ëµì˜ ì„±ê³¼ë¥¼ ê²€ì¦í•©ë‹ˆë‹¤.

### 1. ë°±í…ŒìŠ¤íŠ¸ ì‹¤í–‰

```bash
cd backend

# ì¶”ì„¸ì¶”ì¢… ì „ëµ (ì¶”ì²œ)
uv run ../scripts/run_backtest.py --start 2025-01-01 --strategy trend

# SMA ëŒíŒŒ ì „ëµ
uv run ../scripts/run_backtest.py --start 2025-01-01 --strategy sma

# ê²°ê³¼ íŒŒì¼ ì €ì¥
uv run ../scripts/run_backtest.py --start 2025-01-01 --strategy trend --output ./results
```

### 2. ì§€ì› ì „ëµ ëª©ë¡

| ID | ì „ëµëª… | ì„¤ëª… |
|----|--------|------|
| `trend` | **TrendFollowing** | **(ì¶”ì²œ)** 20ì¼ ì‹ ê³ ê°€ + 50EMA ì¶”ì„¸ + ATR ë³€ë™ì„± í•„í„°. ì†ìµë¹„ ê·¹ëŒ€í™” ì „ëµ. |
| `sma` | SmaBreakout | ì´ë™í‰ê· ì„ (20/60/120) ì •ë°°ì—´ + ì‹ ê³ ê°€ ëŒíŒŒ. |
| `ema` | EmaBreakout | ì§€ìˆ˜ì´ë™í‰ê· (20/50/120) ì •ë°°ì—´ + ì‹ ê³ ê°€ ëŒíŒŒ. |
| `rsi` | RsiSwing | RSI ëˆŒë¦¼ëª© ë§¤ìˆ˜ + ê³¼ë§¤ìˆ˜ ì²­ì‚° (ë‹¨ê¸° ìŠ¤ìœ™). |

---

## ğŸ“Š Technical Indicators (ê¸°ìˆ ì  ì§€í‘œ)

ì‹œìŠ¤í…œì—ì„œ ìë™ ê³„ì‚° ë° ê´€ë¦¬í•˜ëŠ” ì£¼ìš” ê¸°ìˆ ì  ì§€í‘œì…ë‹ˆë‹¤.

| ì§€í‘œëª… | ì„¤ëª… | ì£¼ìš” íŒŒë¼ë¯¸í„°/ì„¤ëª… |
|---|---|---|
| **MA** | ë‹¨ìˆœ ì´ë™í‰ê·  (SMA) | 5, 20, 60, 120, 240ì¼ |
| **EMA** | ì§€ìˆ˜ ì´ë™í‰ê·  (EMA) | 5, 20, 40, 50, 120, 200, 240ì¼ |
| **EMA_STAGE** | **ì´ë™í‰ê·  ëŒ€ìˆœí™˜ ìŠ¤í…Œì´ì§€** | EMA(5, 20, 40) ë°°ì—´ì— ë”°ë¥¸ ì‹œì¥ êµ­ë©´ ì§„ë‹¨ (1~6ë‹¨ê³„) |
| **ATR** | í‰ê·  ë³€ë™ì„± (Usage) | 20ì¼ (ì†ì ˆ ë° í¬ì§€ì…˜ ì‚¬ì´ì§•ìš©) |
| **HIGH** | ê¸°ê°„ ë‚´ ìµœê³  ì¢…ê°€ | 10ì¼, 20ì¼ (ì‹ ê³ ê°€ ëŒíŒŒ ë§¤ë§¤ìš©) |

### ğŸ“ˆ EMA Stage (ì´ë™í‰ê· ì„  ëŒ€ìˆœí™˜ ë¶„ì„)
ë‹¨ê¸°(5ì¼), ì¤‘ê¸°(20ì¼), ì¥ê¸°(40ì¼) ì§€ìˆ˜ì´ë™í‰ê· ì˜ ë°°ì—´ ìƒíƒœë¥¼ ë¶„ì„í•˜ì—¬ í˜„ì¬ ì¶”ì„¸ êµ­ë©´ì„ 6ë‹¨ê³„ë¡œ êµ¬ë¶„í•©ë‹ˆë‹¤.

| Stage | ëª…ì¹­ | ìƒíƒœ (ë°°ì—´) | íˆ¬ì ì „ëµ |
|:---:|:---:|---|---|
| **1** | **ì•ˆì • ìƒìŠ¹ê¸°** | ë‹¨ê¸° > ì¤‘ê¸° > ì¥ê¸° | **[ë§¤ìˆ˜]** ê°•ë ¥í•œ ìƒìŠ¹ ì¶”ì„¸ (ë³´ìœ /ì¶”ê°€ ë§¤ìˆ˜) |
| **2** | í•˜ë½ ë³€í™”ê¸° 1 | ì¤‘ê¸° > ë‹¨ê¸° > ì¥ê¸° | **[ì´ìµ ì‹¤í˜„]** ìƒìŠ¹ì„¸ ë‘”í™”, ì¡°ì • ê°€ëŠ¥ì„± |
| **3** | í•˜ë½ ë³€í™”ê¸° 2 | ì¤‘ê¸° > ì¥ê¸° > ë‹¨ê¸° | **[ë§¤ë„ ì¤€ë¹„]** í•˜ë½ ì „í™˜ ì‹ í˜¸ |
| **4** | **ì•ˆì • í•˜ë½ê¸°** | ì¥ê¸° > ì¤‘ê¸° > ë‹¨ê¸° | **[ë§¤ë„]** í™•ì—°í•œ í•˜ë½ ì¶”ì„¸ |
| **5** | ìƒìŠ¹ ë³€í™”ê¸° 1 | ì¥ê¸° > ë‹¨ê¸° > ì¤‘ê¸° | **[ë§¤ë„ ì²­ì‚°]** ë°”ë‹¥ ë‹¤ì§€ê¸°, ë°˜ë“± ì‹œë„ |
| **6** | **ìƒìŠ¹ ë³€í™”ê¸° 2** | ë‹¨ê¸° > ì¥ê¸° > ì¤‘ê¸° | **[ë§¤ìˆ˜ ê¸‰ì†Œ]** ìƒìŠ¹ ì¶”ì„¸ ì´ˆì… (ì„ ì·¨ë§¤ ê¸°íšŒ) |

---

## ğŸ”§ Utilities & Maintenance (ê´€ë¦¬ ë„êµ¬)

ë°ì´í„° ì •í•©ì„± ìœ ì§€ ë° bulk ì‘ì—…ì„ ìœ„í•œ ë„êµ¬ë“¤ì…ë‹ˆë‹¤.

### ê³¼ê±° ë°ì´í„° ë°±í•„ (Backfill)
íŠ¹ì • ê¸°ê°„ì˜ ë°ì´í„°ë¥¼ ëŒ€ëŸ‰ìœ¼ë¡œ ìˆ˜ì§‘í•˜ê±°ë‚˜ ë‹¤ì‹œ ê³„ì‚°í•  ë•Œ ì‚¬ìš©í•©ë‹ˆë‹¤.

```bash
# 1. ìº”ë“¤ ë°ì´í„° ë°±í•„ (FDR + KRX)
uv run scripts/backfill_candles.py --start 2024-01-01 --end 2024-12-31

# 2. ì§€í‘œ ë°ì´í„° ì¬ê³„ì‚° (DB ìº”ë“¤ ê¸°ì¤€)
uv run scripts/backfill_indicators.py --start 2024-01-01 --end 2024-12-31

# 3. ì‹œì¥ ì§€ìˆ˜(KOSPI/KOSDAQ) ë°±í•„
uv run scripts/backfill_index.py --start 2024-01-01
```

### ë°ì´í„° ê²€ì¦ (Verify)

```bash
# DB ë°ì´í„° ê±´ìˆ˜ ë° ìƒíƒœ í™•ì¸
uv run scripts/verify_db.py

# ì§€í‘œ ë°ì´í„° ì •í•©ì„± í™•ì¸
uv run scripts/verify_indicators.py --start 2026-01-01
```

---

## ğŸ“‚ Project Structure

```
backend/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ api/                   # API Endpoints
â”‚   â”œâ”€â”€ backtest/              # ë°±í…ŒìŠ¤íŠ¸ ì—”ì§„ ë° ì „ëµ í´ë˜ìŠ¤
â”‚   â”‚   â”œâ”€â”€ strategies/        # ê°œë³„ ì „ëµ êµ¬í˜„ì²´ (trend, sma ë“±)
â”‚   â”‚   â””â”€â”€ engine.py          # ë°±í…ŒìŠ¤íŠ¸ ì½”ì–´ ë¡œì§
â”‚   â”œâ”€â”€ services/              # ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ (ìˆ˜ì§‘, ê³„ì‚° ë“±)
â”‚   â”‚   â”œâ”€â”€ collector.py       # ë°ì´í„° ìˆ˜ì§‘ê¸°
â”‚   â”‚   â””â”€â”€ indicator_calculator.py # ì§€í‘œ ê³„ì‚°ê¸°
â”‚   â””â”€â”€ db/                    # DB ì—°ê²° ë° ëª¨ë¸
â”œâ”€â”€ scripts/                   # ì‹¤í–‰ ê°€ëŠ¥í•œ ìœ í‹¸ë¦¬í‹° ìŠ¤í¬ë¦½íŠ¸ ëª¨ìŒ
â”‚   â”œâ”€â”€ daily_routine.py       # [Daily] ì¼ì¼ ë°°ì¹˜ ë©”ì¸
â”‚   â”œâ”€â”€ run_strategy.py        # [Daily] ì‹œê·¸ë„ ìŠ¤ìº”
â”‚   â””â”€â”€ run_backtest.py        # [Backtest] ë°±í…ŒìŠ¤íŠ¸ ì‹¤í–‰
â””â”€â”€ .env                       # í™˜ê²½ ë³€ìˆ˜ (ë¹„ê³µê°œ)
```
